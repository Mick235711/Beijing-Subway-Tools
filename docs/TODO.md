# Beijing Subway
| 线路        | 版本     | 更新时间       | 方向              | Chart     |
|-----------|--------|------------|-----------------|-----------|
| 1号线       | 新16版   | 2024-08-23 | ~~东行~~ ~~西行~~   | ~~Chart~~ |
| 2号线       | 新6版    | 2024-10-29 | ~~外环~~ ~~内环~~   | ~~Chart~~ |
| 3号线       | 新3版    | 2025-03-01 | ~~东行~~ ~~西行~~   | ~~Chart~~ |
| 4号线       | 第6版    | 2024-09-01 | ~~南行~~ ~~北行~~   | ~~Chart~~ |
| 5号线       | 新6版    | 2025-05-20 | ~~南行~~ ~~北行~~   | ~~Chart~~ |
| 6号线       | 新8版    | 2023-09-07 | ~~东行~~ ~~西行~~   | ~~Chart~~ |
| 7号线       | 新8版    | 2023-08-02 | ~~东行~~ ~~西行~~   | ~~Chart~~ |
| 8号线       | 新8版    | 2023-09-11 | ~~南行~~ ~~北行~~   | ~~Chart~~ |
| 9号线       | 新8版    | 2023-09-11 | ~~南行~~ ~~北行~~   | ~~Chart~~ |
| 10号线      | 新4版    | 2022-07-22 | ~~外环~~ ~~内环~~   | ~~Chart~~ |
| 11号线      | 新5版    | 2024-10-29 | ~~南行~~ ~~北行~~   | ~~Chart~~ |
| 12号线      | 新3版    | 2025-03-01 | ~~东行~~ ~~西行~~   | ~~Chart~~ |
| 13号线      | 新7版    | 2024-10-29 | ~~东行~~ ~~西行~~   | ~~Chart~~ |
| 14号线      | 第2版    | 2023-05-31 | ~~东北行~~ ~~西南行~~ | ~~Chart~~ |
| 15号线      | 新6版    | 2023-05-29 | ~~东行~~ ~~西行~~   | ~~Chart~~ |
| 16号线      | 第7版+丽泽 | 2025-01-19 | ~~南行~~ 北行       | ~~Chart~~ |
| 17号线      | 第2版    | 2023-12-30 | ~~南行~~ ~~北行~~   | ~~Chart~~ |
| 19号线      | 第5版    | 2024-02-26 | ~~南行~~ ~~北行~~   | ~~Chart~~ |
| 亦庄线       | 新3版    | 2025-04-17 | ~~进城~~ ~~出城~~   | ~~Chart~~ |
| 房山线       | 新8版    | 2023-09-11 | ~~进城~~ ~~出城~~   | ~~Chart~~ |
| 燕房线       | 第3版    | 2024-02-26 | ~~进城~~ ~~出城~~   | ~~Chart~~ |
| S1线       | 新4版    | 2021-12-31 | ~~进城~~ ~~出城~~   | ~~Chart~~ |
| 昌平线       | 新13版   | 2024-12-15 | ~~进城~~ ~~出城~~   | ~~Chart~~ |
| 西郊线       | 亿通行版   | 2024-11-08 | ~~进城~~ ~~出城~~   | ~~Chart~~ |
| ~~亦庄T1线~~ | （不做了）  |
| 首都机场线     | 新7版    | 2024-05-11 | ~~进城~~ ~~出城~~   | ~~Chart~~ |
| 大兴机场线     | 第6版    | 2024-11-23 | ~~进城~~ ~~出城~~   | ~~Chart~~ |

TBD:
- 6/7号线2025.4.10调图
    - 6号线等潞阳，7号线仅工作日变化
- 9/房山2024.9.10调图
- 10号线2024年调图

近期:
- 北京2025年底
    - 6南新图
    - 17贯通新图
    - 18（13拆）新图
- 台北2025年底
    - 淡水线延长一站

## 时刻表错误
- 1号线
  - 东行
    - 公主坟双休日时刻表缺17:57
    - 王府井双休日时刻表缺17:54 17:57
    - 东单双休日时刻表缺16:56 16:59 17:56 17:59
    - 建国门工作日时刻表多19:38，缺21:56 22:03 22:09 22:16 22:23 22:30
    - 管庄工作日时刻表多00:00
  - 西行
    - 环球度假区双休日时刻表多05:00
    - 九棵树工作日时刻表缺22:46 22:53
    - 果园工作日时刻表缺22:55
    - 通州北苑工作日时刻表缺23:12
    - 四惠东双休日时刻表05:34同样为出库车
    - 建国门工作日时刻表缺20:52 21:01 21:21 21:38 22:14
- 2号线
  - 外环
    - 车公庄工作日时刻表07:32重复
    - 宣武门工作日时刻表缺20:01
    - 和平门工作日时刻表缺08:56
    - 前门工作日时刻表缺17:15
    - 北京站工作日时刻表15:15误写成15:145
    - 建国门工作日时刻表16:48误写成16:18
    - 雍和宫工作日时刻表缺08:01
  - 内环
    - 建国门工作日时刻表17:53误写成17:43
    - 北京站工作日时刻表缺16:29
    - 长椿街工作日时刻表缺05:57 17:57
    - 阜成门工作日时刻表19:29误写成19:39
    - 西直门工作日时刻表多19:01
- 13号线
  - 西行
    - 回龙观双休日时刻表05:56应为霍营出库车
    - 龙泽双休日时刻表05:58应为霍营出库车
    - 清河站双休日时刻表06:06应为霍营出库车
    - 上地双休日时刻表06:09应为霍营出库车
    - 五道口双休日时刻表06:14应为霍营出库车
- 16号线
  - 北行
    - 万泉河桥双休日时刻表小时23写成22
- 昌平线
  - 进城
    - 朱房北工作日时刻表05:36应为朱辛庄出库车
    - 清河小营桥工作日和双休日时刻表05:39应为朱辛庄出库车
    - 学知园工作日和双休日时刻表05:42应为朱辛庄出库车
    - 六道口工作日和双休日时刻表05:45应为朱辛庄出库车
    - 学院桥工作日和双休日时刻表05:47应为朱辛庄出库车
    - 西土城工作日时刻表始发站纯属乱标，14:01多余，13:36误写成13:26
    - 西土城双休日时刻表多14:43, 22:59
- 首都机场线
  - 进城
    - 三元桥周五时刻表多16:10
    - 东直门周五时刻表多16:14

# Taipei Metro
台北+新北+桃园捷运。包括环状线，机场捷运，淡水轻轨，安坑轻轨，不包括台铁/高铁。数据来源：
- 时刻表（目前版本：2023/11公布）
  - R/G/O/BL: [台北捷运官方网站](https://www.metro.taipei/cp.aspx?n=91974F2B13D997F1)
  - BR: MetroMan地铁通非官方时刻表
  - Y: 无时刻表，根据[新北捷运官网](https://www.ntmetro.com.tw/basic/?mode=detail&node=662)间隔数据推算，请勿过度依赖
  - 两条轻轨: [新北捷运官方网站](https://www.ntmetro.com.tw/basic/?mode=detail&node=460)
  - 机场捷运: [桃园捷运官方网站](https://www.tymetro.com.tw/tymetro-new/tw/_pages/travel-guide/timetable.php)
- 换乘时间: [Blog](https://blog.transtaiwan.com/blog/transfer-time-settings/)
- 各站站间距: [PTT](https://www.ptt.cc/bbs/MRT/M.1342435699.A.99B.html)


# Enhancements
- [x] 快车实现：正常记录过站时间，但是不允许上车（显示passing/通过）
- [x] 东西南北 East West South North 桥 Bridge ...
- [x] 多音字处理：十里堡 pu 朝阳门 chao
- avg_shortest Min/Max显示
  - [x] 出发时间 （或许显示route时直接显示起终时间更好？)
  - [x] 每个径路的示例时间
- [x] First/Last Train显示线路
- [x] 末班车First/Last Leaving Train
- [x] Train type/carriage number (etc 6B) + 设计速度
- [x] 部分节点低峰时段允许逆行（Special Rules）
- [x] 文档：每个py文件的参数说明
- [x] 旅速：per line & average (+min/max)
- [x] 表格版per line旅速（+站间距，首末站，每天列车数量等等）
- [x] 每天列车数量，总运行距离，总运量，总车距离，总人距离
- [x] 最快/最慢车排除某些线路（比如有鬼）
- [x] Per minute train count graph
- [x] 最长/短站间距
- [x] Moving Average: 每30/60min最高/低运量/列车数
- [x] Add total row to highest_speed
- [x] Add include/exclude support to highest_speed
- [x] 站/区间断面30/60min最高/低运量/列车数
- [x] Embed include_edge into options
- [x] 和环线相似的快车专门分析：平均速度，平均用时，同区间快多少，越行几次
- [x] show_loop扩展到普通线路（出库-折返-回库）
- [x] 数字编号排序
- [x] 最早/最晚路径
- [x] contour vs contourf调整
- [x] 环线加入出库车自动判定（注：目前无法实现时刻表中标注，只有算出列车后的标注）
- [x] Allow sort by multiple columns
- [x] 优化avg_shortest，每分钟更改为每列车开始
- [x] ~~多线程与~~进度条
- [x] 拆分highest_speed，改名city_statistics
- [x] --exclude-edge扩展到首/末班车
- [x] 各类表格的CSV输出
- [x] 虚拟换乘
- [x] 高价快线避免选项
- [x] 跨线车支持 (注：BFS暂不支持，仅支持查看；用0分钟换乘模拟)
- [x] 最短路增强：~~最少换乘~~/最短距离/最短站数
- [ ] 最长路增强：任意两站间最长的站数/距离
- [x] 支持画图中显示平均换乘次数/平均距离/平均站数
- [ ] draw_equtime支持等距离等站数
- [x] 多起点画图
- [x] 多颜色路径画图
- [x] 画图contour强调选项-f
- [x] 各种格式导出dist_graph
  - [ ] 扩展：每站列车数作为node weight
- [ ] 区间旅速比较（某区间的旅速比其他区间快多少）
- [ ] 某线某一时刻上线列车列表及位置
  - [x] 对接[beijing-subway-schedule](https://github.com/BoyInTheSun/beijing-subway-schedule)项目
- [ ] 平均间隔，高峰平均间隔，平均全程车占比，高峰全程车占比
- [x] 首末班车线路模式（某一线路从头到尾每一站的首末班车，直观看交路）
  - [x] 高级单站模式：提示换乘到其他线路的最晚时间
  - [x] 虚拟换乘高级单站
  - [x] 支持--full与--all
- [x] 阶梯状一线内所有站点对行车时间/价格表
- [ ] 为同站出站换乘添加virtual标识
  - [ ] 同站名虚拟换乘支持（木樨地）
- [x] --reverse支持索引
- [x] --show和--hide显示/隐藏列
- [x] 换乘平均等车时间/>N min的比率 (TODO: Add example timing)
- 完善文档
  - [x] create a new line
  - [x] tools
- [ ] 中文文档
- [ ] 其他城市特性
  - [ ] 多语言支持
  - [x] 车站/线路编号
  - [ ] 副站名
  - [ ] 站台编号与逐站台时刻表
- 城市统计
  - [x] 多线换乘站数量
  - [x] 各线（连续）换乘站比例
  - [x] 车站字数
  - [x] 常用字统计
  - [x] 换乘时间
- [x] 各类平均数的标准差支持 (`city_statistics.py` & `show_express_trains.py` not done)
- [x] 最短/最长站间距
- [x] exotic path：两种metric（比如distance和time）路径差距最大的排行
  - [x] 单线模式
  - [x] 支持多个metric
- [x] 车费支持
  - [x] 多种车费基础（距离，站数）+换乘连续计费
  - [x] 折扣/附加费
  - [ ] 换乘优惠
  - [ ] 根据偏移量（+nkm）描述车费
  - [ ] 实现暂缓换乘站功能
  - [x] BFS显示车费
  - [x] BFS按车费排序
  - [ ] 城市统计 - 车费
  - [x] 低峰优惠票价
- 对所有display_first列表：
  - [ ] 直方图
  - [ ] 某条线/某站引起的变更
- 对所有dist_graph相关：
  - [x] Best Path：一个AbstractPath一天中最好的出发时间
  - [x] 加入--exclude-next-day

## 线网径路PK：对于同一个首末站组合，指定不同径路
- 指定径路：
  - [x] 指定线路自动生成（例如5号线-1号线[西行]-4号线，或者菜单选换乘站）
  - [x] 最短的N个路径
  - [x] 最短路按时间/距离/站数/费用/...
  - [x] 全天最短路（百分比）
  - [x] 最长路（dist_graph）
  - [x] 指定途经点
  - 不允许经过
    - [x] 某线
    - [ ] 某站
- 输出统计：
  - [x] 每个径路平均所需时间，最大时间，最小时间
  - [x] 每个径路展示具体最大/最小路径
  - [x] 每个径路最晚可出发时间
  - [x] 每个径路占优百分比
  - [x] 分时段占优路径枚举
  - [x] 单独最短/长时间 & 例子
  - [ ] 相对最短/长时间（即#1 - #2极值）
- [x] 画图
- [x] 画趋势折线图
- [ ] 线路/数据导入导出

## 高难度/远期
- [x] 多线程支持
- [ ] 反转整个图，BFS创造单终点最短路（即到某站的最短时间）
- [ ] 到某线路的画图（比如到10号线的平均时间）
- [ ] 增强版最短路
  - [ ] 多源多汇
  - [ ] 单独附加分钟数（例如到A站出发+0min，到B站出发+3min）
- [ ] 支线支持
- [ ] 换乘系数（avg shortest）：两站之间每分钟最短时间路径的换乘次数/距离平均（顺便也添加上最短/长时间/距离）
- 图忽略
  - [x] 某条线
  - [ ] 某站/某个换乘
- [ ] 某条线延长N站（输入站名，运行时间，如果不存在可以输入坐标）
- [ ] 运行图输出（[参考](https://www.zhihu.com/question/27281523/answer/36034502)）
- 更多城市
  - [x] 台北
  - [ ] 苏州
- [x] 最长路算法
- [ ] 最少换乘路线
- [x] 在地图上绘制最短路
- [x] 拥挤度（每对OD模拟1人次客流，看各段/各站/各换乘方向客流）
  - [x] 每线客流（进站/换乘/总）/客强
  - [x] 最大客流区间，最拥挤区间
  - [x] 最大换乘量/换乘方向
  - [ ] 为每个站绘制客流量/换乘量
- [ ] 距离metric的k-最短路
- [ ] 开通日期（optional，毕竟有换乘，wb东管头南有统计）
- [ ] Use color to represent different train routes (optional)

## Known Bugs
- 本质上时刻表上的最短路是NP-Hard（因为不满足最优子结构），所以BFS其实不成立
  - 例子：大兴机场-3号航站楼工作日15:47出发。大兴机场到三元桥DAE-19-10比DAE-10快3分钟，然而两者会归并到同一趟CAE上，后者少一次换乘，导致更优子结构带来更差路径
  - 如果要解决可能只能把所有最短路全算一遍，运算量过大
  - 目前悲观估计约有不多于0.07%的OD对受此影响无法得出时间上最佳路径。时间相同的非最佳路径的情况多得多，几乎每一对OD都会有这样的例子
  - 因此，请不要过于依赖avg_shortest的百分比。如需要精确正确答案，请使用路径PK系统对前~30路径进行计算
- 费率计算按全程最短路计，涉及分段计费时可能结果不正确
  - 例子：2号航站楼-磁器口工作日07:30出发，全程最短路为CAE-2-崇文门-5仅30.19km，然而计价为25+4；实际最佳路线为CAE-5共30.68km，更长但计价25+3
  - 目前约有小于20个（0.015%）OD对受此影响无法得出最佳计费路径
- 虚拟换乘允许单行程内出现多次
- 多线程时进度条卡住
- BFS并不真正考虑直通车，使用0分钟换乘模拟 (Hard to fix)
- BFS不支持缓急接续等需要同线换乘的场景
- 暂时不支持以站数或者距离为基准的k-最短路
- 因技术原因，dist_graph不支持include_express
- --exclude-virtual不考虑同站名出站换乘（木樨地）
- 由于argparse限制，--level, --focus和--style-spec的第二参数不能以-开头（例如-15,15不行，要换成15,-15）
- `derive_from`不会继承组中的`inner_basis`和`apply_time`，并且需要被继承的组在前面
- BFS处理虚拟换乘时有时会直接使用更差的选择
- k最短路无法正确处理快车，如果最短路选择快车将会直接忽略快车跳过的站
- 路径PK中如果第一个路径是虚拟换乘，那么默认从该站点开站（各线路最早首班车）开始；可能造成平均时间和最高时间虚高
